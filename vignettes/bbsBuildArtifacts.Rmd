---
title: "bbsBuildArtifacts: filtering build reports"
author: "Vincent J. Carey, stvjc at channing.harvard.edu"
date: "`r format(Sys.time(), '%B %d, %Y')`"
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{bbsBuildArtifacts: filtering build reports}
  %\VignetteEncoding{UTF-8}
output:
  BiocStyle::html_document:
    highlight: pygments
    number_sections: yes
    theme: united
    toc: yes
---

# Introduction

We'd like to be able to get a quick overview of status for a
subset of Bioconductor packages.  "Status" is relative to
Bioconductor version, package version, build platform, and
condition of the platform.

## New approach, December 2021

We want to be able to work with the current artifacts provided
at, e.g., `https://bioconductor.org/checkResults/3.15/bioc-LATEST/report.tgz`.
Such gzipped tar resources are prepared for different types
of resource.

```{r lktypes}
suppressPackageStartupMessages({
  library(bbsBuildArtifacts)
  library(dplyr)
  library(DT)
})
bbsBuildArtifacts:::valid_types()
```

We'll focus on type `bioc` for now, which associates with Software packages.
We don't know if all types are handled in the same way, but we hope so.

Our objective is to learn the status and processing times for
various phases of the build process for all packages.

### Download and cache the report.tgz

```{r demo1}
our_cache = BiocFileCache::BiocFileCache()
cid = get_report_tgz_cacheid(version = "3.14", type="bioc", cache=our_cache)
cid
our_cache[cid] # metadata
our_cache[[cid]]  # actual path
```

There is an unexported helper function to clean the cache of
a path for a given version/type combination.

### Process install-, build-, and check-related contents of a package

We do not cache the untarred data.  The untar process must
occur each time we want to analyze the artifacts.

```{r lkallp}
allpaths = artifact_folder_paths(version = "3.14", type="bioc", cache=BiocFileCache::BiocFileCache())
allpaths
```

The `package_by_host_data` function will parse the DCF files
created for each package by the BBS.

```{r lkpbh}
allpaths["parody"] # simple retrieval
package_by_host_data(allpaths["parody"])
```

We can produce a data table for a number of packages as follows.

```{r domore}
few = allpaths[1:10]
dcfs = lapply(few, function(x) simplify_artifact_build_dcfs(package_by_host_data(x)))
tab = do.call(rbind, unname(dcfs))
library(DT)
datatable(tab)
```

Building a comprehensive table requires some fault tolerance.  We
have used silent `try` calls in `package_by_host_data`; silent can
be set to FALSE if desired.

```{r doall}
suppressWarnings({
alldcfs = lapply(allpaths, function(x) simplify_artifact_build_dcfs(package_by_host_data(x)))
})
fulltab = do.call(rbind, unname(alldcfs))
```

Let's get a sense of the distribution of build times.

```{r lkbtr}
library(dplyr)
bdat = fulltab |> filter(phase=="buildsrc")
hist(bdat$elapsed_time)
sum(bdat$elapsed_time > 600)
```



## Example -- legacy approach

We have the artifacts for Bioconductor 3.13 for a small
number of packages.  These are placed in `tempdir()`
via `setup_demo_artifacts()`.

`select_artifacts` takes the path to a collection
of artifacts, and a vector of regular expressions to
isolate a group of packages of interest.

```{r chk1}
suppressPackageStartupMessages({
library(bbsBuildArtifacts)
library(DT)
})
setup_demo_artifacts() # writes to tempdir()
hpath = paste(tempdir(), "tokay2", sep="/")
eg = select_artifacts(hpath, c("IRanges", "S4V*", "a4\\."))
eg
```
We use the fact that the artifact for package `a4` will 
have a period right after the package name to select only
it and no other packages with names starting with the string `a4`.

Various outcomes can be retrieved from an artifact collection:
```{r lkela}
get_process_outcomes(eg, "buildsrc", "EllapsedTime")
get_process_outcomes(eg, "buildbin", "PackageFileSize")
```

A simple way to generate a more comprehensive table for a host is:
```{r domo}
tabulate_bbs_metrics( c("IRanges", "^S4V", "a4"), hpath)
```

To acquire detailed text on errors, warnings and notes, use `get_events`.

```{r lkev}
ev = get_events(eg)
sapply(ev, sapply, length)
```

# A larger example

We have a snapshot of build artifacts from 2021 June 14, to which
`tabulate_bbs_metrics` was applied.

```{r lksnap}
data(sc_614)
datatable(sc_614)
```
